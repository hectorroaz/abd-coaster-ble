<!doctype html>
<html lang="es">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ABD Coaster – Contador (BLE)</title>
<style>
  :root{--bg:#0b0b0d;--panel:#131317;--muted:#8b8b98;--accent:#5eead4;--text:#e6e6f0;--danger:#ef4444;--ok:#10b981}
  html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .wrap{max-width:880px;margin:0 auto;padding:18px}
  header{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
  .btn{appearance:none;border:1px solid #2a2a33;background:#1a1a22;color:var(--text);padding:.7rem 1rem;border-radius:12px;cursor:pointer;font-weight:600}
  .btn:hover{border-color:#3b3b46}
  .btn.primary{background:#1a2a29;border-color:#274c45;color:var(--accent)}
  .btn.danger{border-color:#3a1618;background:#1f0e10;color:var(--danger)}
  .row{display:grid;grid-template-columns:repeat(12,1fr);gap:14px;margin-top:16px}
  .card{grid-column:span 12;background:var(--panel);border:1px solid #20202a;border-radius:18px;padding:16px}
  @media(min-width:720px){.card.span6{grid-column:span 6}.card.span4{grid-column:span 4}.card.span8{grid-column:span 8}}
  .label{font-size:.9rem;color:var(--muted);letter-spacing:.04em;text-transform:uppercase}
  .big{font-size:5rem;line-height:1;font-weight:800;margin:.25em 0;cursor:pointer}
  .timer{font-variant-numeric:tabular-nums;font-size:2rem}
  .stat{font-variant-numeric:tabular-nums;font-size:1.6rem;font-weight:700}
  .muted{color:var(--muted)}
  .pill{display:inline-block;padding:.25rem .6rem;border-radius:999px;border:1px solid #2a2a33;color:var(--muted);font-size:.85rem}
  footer{margin:22px 0;color:var(--muted);font-size:.9rem}
  .toggle{display:inline-flex;align-items:center;gap:.5rem}
  .toggle input{width:18px;height:18px}

  /* Pantalla completa (overlay) */
  .fullscreen{position:fixed;inset:0;background:#000;display:none;align-items:center;justify-content:center}
  .fullscreen.active{display:flex}
  .fsNum{color:#fff;font-weight:900;font-variant-numeric:tabular-nums;line-height:1;text-align:center;font-size:22vw}
  .fsHint{position:fixed;bottom:14px;left:0;right:0;text-align:center;color:#aaa;font-size:.95rem}
</style>

<div class="wrap">
  <header>
    <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
      <button id="btnConnect" class="btn primary">Conectar BLE</button>
      <button id="btnReset" class="btn danger">Reset sesión</button>
      <label class="toggle"><input type="checkbox" id="vibrate"> Vibrar en cada rep</label>
    </div>
    <span id="status" class="pill">Desconectado</span>
  </header>

  <div class="row">
    <section class="card span8">
      <div class="label">Repeticiones (toca para ver en pantalla completa)</div>
      <div id="reps" class="big">0</div>
      <div class="label">Cronómetro (desde la 1ª rep)</div>
      <div id="timer" class="timer">00:00</div>
    </section>

    <section class="card span4">
      <div class="label">Cadencia media</div>
      <div id="avgCad" class="stat">0.00 rpm</div>
      <div class="label" style="margin-top:8px">Cadencia instantánea</div>
      <div id="instCad" class="stat">—</div>
      <div class="label" style="margin-top:8px">Mejor cadencia</div>
      <div id="bestCad" class="stat">—</div>
    </section>

    <section class="card span6">
      <div class="label">Tiempo última repetición</div>
      <div id="lastInt" class="stat">—</div>
      <div class="muted" style="margin-top:6px">Tiempo entre las dos últimas reps.</div>
    </section>

    <section class="card span6">
      <div class="label">Notas de sesión</div>
      <div id="notes" class="muted">Conecta el dispositivo y empieza a moverte; el cronómetro arranca con la primera repetición.</div>
    </section>
  </div>

  <footer><span class="muted">HR Creativos · ESP32 + Web Bluetooth · Tema oscuro</span></footer>
</div>

<!-- Overlay pantalla completa -->
<div id="fs" class="fullscreen" onclick="exitFullScreen()">
  <div class="fsNum" id="fsNum">0</div>
  <div class="fsHint">Toca para salir</div>
</div>

<script>
/* ======== BLE UUIDs ======== */
const SERVICE = '7b1e0001-8b6b-4b6d-b6b3-6f6b7b1e0001';
const REPS    = '7b1e0004-8b6b-4b6d-b6b3-6f6b7b1e0001'; // uint32 (reps)

/* ======== UI refs ======== */
const $ = s => document.querySelector(s);
const ui = {
  btnConnect: $('#btnConnect'),
  btnReset:   $('#btnReset'),
  vibrate:    $('#vibrate'),
  status:     $('#status'),
  reps:       $('#reps'),
  timer:      $('#timer'),
  avgCad:     $('#avgCad'),
  instCad:    $('#instCad'),
  bestCad:    $('#bestCad'),
  lastInt:    $('#lastInt'),
  notes:      $('#notes'),
  fs:         $('#fs'),
  fsNum:      $('#fsNum'),
};

/* ======== Estado ======== */
let device, server, svc, chReps;
let lastRepValue = 0;
let sessionReps = 0;
let sessionStartMs = null;
let timerId = null;
let lastRepTs = null;
let bestCadRPM = 0;

/* ======== Util ======== */
function fmtTime(ms){ if (ms==null) return '00:00'; const s=Math.floor(ms/1000); return `${String(Math.floor(s/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`; }
function setStatus(txt, ok=false){ ui.status.textContent=txt; ui.status.style.color = ok ? 'var(--ok)' : 'var(--muted)'; }

/* ======== Wake Lock robusto ======== */
let wakeLock=null;
async function requestWakeLock(){ try{ if('wakeLock' in navigator){ wakeLock = await navigator.wakeLock.request('screen'); wakeLock.addEventListener('release',()=>console.log('WakeLock liberado')); } }catch(e){ console.warn('WakeLock no disponible:', e.message); } }
document.addEventListener('visibilitychange', ()=>{ if (document.visibilityState==='visible' && wakeLock==null) requestWakeLock(); });
requestWakeLock();

/* ======== Timer Sesión ======== */
function startTimerIfNeeded(){
  if (sessionStartMs!==null) return;
  sessionStartMs = Date.now();
  timerId = setInterval(()=>{
    const elapsed = Date.now()-sessionStartMs;
    ui.timer.textContent = fmtTime(elapsed);
    const min = elapsed/60000;
    ui.avgCad.textContent = `${min>0 ? (sessionReps/min).toFixed(2) : '0.00'} rpm`;
  },1000);
}
function resetSession(){
  sessionReps=0; lastRepValue=0; lastRepTs=null; bestCadRPM=0;
  if (timerId) clearInterval(timerId); timerId=null; sessionStartMs=null;
  ui.reps.textContent='0'; ui.fsNum.textContent='0';
  ui.timer.textContent='00:00'; ui.avgCad.textContent='0.00 rpm';
  ui.instCad.textContent='—'; ui.bestCad.textContent='—'; ui.lastInt.textContent='—';
  ui.notes.textContent='Sesión reiniciada.';
}
ui.btnReset.addEventListener('click', resetSession);

/* ======== Pantalla completa ======== */
ui.reps.addEventListener('click', async ()=>{
  ui.fs.classList.add('active');
  // intenta fullscreen del navegador
  try{ if(document.fullscreenElement==null){ await document.documentElement.requestFullscreen(); } }catch(e){}
});
async function exitFullScreen(){
  ui.fs.classList.remove('active');
  try{ if(document.fullscreenElement){ await document.exitFullscreen(); } }catch(e){}
}
window.exitFullScreen = exitFullScreen;

/* ======== Lógica de datos ======== */
function onRepsValue(dv){
  const repsVal = dv.getUint32(0,true);
  if (repsVal>lastRepValue){
    const inc = repsVal - lastRepValue;
    sessionReps += inc;
    ui.reps.textContent = sessionReps.toString();
    ui.fsNum.textContent = sessionReps.toString();

    if (ui.vibrate.checked && navigator.vibrate) navigator.vibrate(15);
    startTimerIfNeeded();

    const now = Date.now();
    if (lastRepTs!==null){
      const dt = now - lastRepTs;
      const rpm = 60000/dt;
      ui.lastInt.textContent = `${(dt/1000).toFixed(2)} s`;
      ui.instCad.textContent = `${rpm.toFixed(2)} rpm`;
      if (rpm>bestCadRPM){ bestCadRPM=rpm; ui.bestCad.textContent=`${bestCadRPM.toFixed(2)} rpm`; }
    }
    lastRepTs = now;
    ui.notes.textContent = `¡Vamos! Reps en esta sesión: ${sessionReps}`;
  }
  lastRepValue = repsVal;
}

/* ======== Conexión BLE – filtros flexibles ======== */
async function connectBLE(){
  try{
    setStatus('Buscando...', false);

    // 1) Preferimos por SERVICIO (si el anuncio incluye el UUID)
    // 2) O por nombre (si por servicio no aparece)
    // 3) Plan C: acceptAllDevices
    let dev;
    try{
      dev = await navigator.bluetooth.requestDevice({
        filters: [
          { services: [SERVICE] },
          { namePrefix: 'ESP32' },
          { name: 'ESP32-Pulsos' }
        ],
        optionalServices: [SERVICE]
      });
    }catch(e){
      if (e.name==='NotFoundError'){
        dev = await navigator.bluetooth.requestDevice({
          acceptAllDevices: true,
          optionalServices: [SERVICE]
        });
      }else{ throw e; }
    }

    device = dev;
    server = await device.gatt.connect();
    svc = await server.getPrimaryService(SERVICE);
    chReps = await svc.getCharacteristic(REPS);
    chReps.addEventListener('characteristicvaluechanged', e => onRepsValue(e.target.value));
    await chReps.startNotifications();

    setStatus('Conectado', true);
    ui.notes.textContent = 'Conectado. La 1ª repetición inicia el cronómetro.';
    requestWakeLock(); // refuerza mantener pantalla encendida
  }catch(err){
    console.error(err);
    setStatus('Error de conexión', false);
    alert('No pude conectar: ' + err.message);
  }
}
ui.btnConnect.addEventListener('click', connectBLE);
</script>
</html>
